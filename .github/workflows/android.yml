name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: mobileshepherd/python-for-android:latest
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Copy project into container
        run: |
          mkdir -p /home/builder/project
          cp -r ./* /home/builder/project/
          chown -R builder:builder /home/builder/project
          cd /home/builder/project

      - name: Build APK with p4a
        run: |
          cd /home/builder/project
          sudo -u builder python -m pythonforandroid.toolchain apk \
            --private . \
            --package=org.example.smartlift \
            --name="SmartLift" \
            --version=1.0 \
            --bootstrap=sdl2 \
            --requirements=python3,kivy==2.2.1,pillow,sdl2 \
            --arch=arm64-v8a \
            --copy-libs \
            --dist-name=smartlift \
            --android-api=33 \
            --ndk-api=21 \
            --whitelist=whitelist.txt \
            --presplash=Preplash.png \
            --icon=Icon.png \
            --orientation=portrait \
            --permission=INTERNET \
            --wakelock \
            --release \
            --color=always

      - name: Upload APK
        run: |
          cp /home/builder/project/dist/smartlift/*.apk /github/workspace/ || true

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SmartLift-APK
          path: |
            *.apk
            !venv/
          if-no-files-found: error
