name: Build Android Universal APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-universal:
    name: Build Universal APK (arm64-v8a, armeabi-v7a, x86_64)
    runs-on: ubuntu-latest

    env:
      # Android / tool versions (kept in one place)
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_VERSION: 27.2.12479018          # NDK r27c
      ANDROID_API: 33
      NDK_API: 21
      ANDROID_BUILD_TOOLS: 35.0.0

      # p4a / dist
      DIST_NAME: smartlift

      # Download URLs + SHA256 (verified)
      SDK_URL: https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
      SDK_SHA: 15f4a3fddfd7ad62d3a5b450f8b93f4dbfa1f09d6e853b3c7bafbd8aab5b6b89

      NDK_URL: https://dl.google.com/android/repository/android-ndk-r27c-linux.zip
      NDK_SHA: ac3025e28bcdb1c2fdc61ac5b7a5b0575870b798baf4f1b594a4db78b82b45a6

      ANT_URL: https://archive.apache.org/dist/ant/binaries/apache-ant-1.10.13-bin.tar.gz
      ANT_DIR: ${{ github.workspace }}/apache-ant-1.10.13

      # Bundletool (used to turn AAB into one universal APK)
      BUNDLETOOL_JAR: ${{ github.workspace }}/bundletool-all.jar
      BUNDLETOOL_URL: https://github.com/google/bundletool/releases/download/1.16.0/bundletool-all-1.16.0.jar

      # Keystore (throwaway for CI builds)
      KEYSTORE_PATH: ${{ github.workspace }}/ci-release.keystore
      KEY_ALIAS: smartlift
      KEYSTORE_PASS: android
      KEY_PASS: android

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- CACHES ----------
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt', 'buildozer.spec', 'main.py') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Cache Android SDK cmdline-tools
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: |
            android-sdk/cmdline-tools/latest
            android-sdk/platform-tools
          key: sdk-${{ env.ANDROID_API }}-${{ env.ANDROID_BUILD_TOOLS }}-${{ runner.os }}
          restore-keys: |
            sdk-${{ runner.os }}

      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: android-sdk/ndk/${{ env.ANDROID_NDK_VERSION }}
          key: ndk-${{ env.ANDROID_NDK_VERSION }}-${{ runner.os }}
          restore-keys: |
            ndk-${{ runner.os }}

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Cache p4a dist
        id: cache-p4a
        uses: actions/cache@v4
        with:
          path: .p4a/dists/${{ env.DIST_NAME }}
          key: p4a-${{ env.DIST_NAME }}-${{ runner.os }}-${{ hashFiles('buildozer.spec', 'main.py', 'requirements.txt') }}
          restore-keys: |
            p4a-${{ env.DIST_NAME }}-${{ runner.os }}-

      # ---------- PYTHON & SYSTEM ----------
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          set -euo pipefail
          sudo apt update -qq
          sudo apt install -y unzip openjdk-17-jdk wget python3-pip libffi-dev libssl-dev libsqlite3-dev \
                              libjpeg-dev zlib1g-dev build-essential libgl1-mesa-dev coreutils zip

      - name: Install Apache Ant (cached)
        run: |
          set -euo pipefail
          if [ ! -d "${ANT_DIR}" ]; then
            wget -O ant.tgz "${ANT_URL}"
            tar -xzf ant.tgz
          fi
          echo "${ANT_DIR}/bin" >> "$GITHUB_PATH"

      - name: Install Cython and python-for-android
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install "Cython==0.29.33"
          # Use develop for latest Android/Gradle fixes
          pip install --upgrade "git+https://github.com/kivy/python-for-android.git@develop"

      # ---------- FIX LIBFFI RECIPE (deterministic; no background wait) ----------
      - name: Patch libffi recipe (deterministic, fail if not applied)
        run: |
          set -euo pipefail
          P4A_DIR=$(python - <<'PY'
import pythonforandroid, os
print(os.path.dirname(pythonforandroid.__file__))
PY
)
          RECIPE="${P4A_DIR}/recipes/libffi/__init__.py"
          if [ ! -f "${RECIPE}" ]; then
            echo "❌ libffi recipe not found at ${RECIPE}"
            exit 1
          fi
          echo "ℹ️ Patching ${RECIPE}"

          # Idempotent edits:
          # 1) Ensure env["HAVE_HIDDEN"] = "0" after LDFLAGS line
          if ! grep -q 'env\["HAVE_HIDDEN"\] = "0"' "${RECIPE}"; then
            sed -i '/"LDFLAGS="/a\        env["HAVE_HIDDEN"] = "0"' "${RECIPE}"
          fi

          # 2) Add --disable-raw-api next to --enable-shared (once)
          if ! grep -q '"--disable-raw-api"' "${RECIPE}"; then
            sed -i 's/"--enable-shared"/"--enable-shared", "--disable-raw-api"/' "${RECIPE}"
          fi

          echo "✅ libffi recipe patched"

      # ---------- ANDROID SDK / NDK ----------
      - name: Download Android SDK Command-line Tools (retry + checksum)
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools"
          cd "${ANDROID_SDK_ROOT}/cmdline-tools"
          for i in {1..5}; do
            echo "Attempt $i: Downloading SDK tools…"
            wget --timeout=30 --tries=3 "$SDK_URL" -O sdk.zip && break || true
            echo "⚠️  Download failed, retrying in 15s…"; rm -f sdk.zip; sleep 15
          done
          [ -f sdk.zip ] || { echo "❌ Failed to download SDK after retries"; exit 1; }

          echo "${SDK_SHA}  sdk.zip" | sha256sum -c --status || { 
            echo "❌ SDK checksum mismatch"; 
            echo "Expected: ${SDK_SHA}"; 
            echo "Actual:   $(sha256sum sdk.zip | cut -d' ' -f1)";
            exit 1; 
          }
          unzip -q sdk.zip
          mkdir -p latest
          mv cmdline-tools/* latest/
          rmdir cmdline-tools
          rm -f sdk.zip

      - name: Add SDK tools to PATH
        run: |
          echo "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "${ANDROID_SDK_ROOT}/platform-tools" >> "$GITHUB_PATH"

      - name: Accept Android licenses
        run: |
          set -euo pipefail
          mkdir -p "${ANDROID_SDK_ROOT}/licenses"
          # Android SDK license hashes (platform + preview)
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >  "${ANDROID_SDK_ROOT}/licenses/android-sdk-license"
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "${ANDROID_SDK_ROOT}/licenses/android-sdk-license"

      - name: Install SDK components
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "build-tools;${ANDROID_BUILD_TOOLS}"

      - name: Download Android NDK r27c (retry + checksum)
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          mkdir -p "${ANDROID_SDK_ROOT}/ndk"
          cd "${ANDROID_SDK_ROOT}/ndk"
          for i in {1..5}; do
            echo "Attempt $i: Downloading NDK r27c…"
            wget --timeout=30 --tries=3 "$NDK_URL" -O ndk.zip && break || true
            echo "⚠️  Download failed, retrying in 15s…"; rm -f ndk.zip; sleep 15
          done
          [ -f ndk.zip ] || { echo "❌ Failed to download NDK after retries"; exit 1; }

          echo "${NDK_SHA}  ndk.zip" | sha256sum -c --status || { 
            echo "❌ NDK checksum mismatch"; 
            echo "Expected: ${NDK_SHA}"; 
            echo "Actual:   $(sha256sum ndk.zip | cut -d' ' -f1)";
            exit 1; 
          }
          unzip -q ndk.zip
          mv android-ndk-r27c "${ANDROID_NDK_VERSION}"
          rm -f ndk.zip

      # ---------- BUILD (AAB -> UNIVERSAL APK) ----------
      - name: Build AAB with python-for-android (multi-ABI)
        env:
          ANDROID_NDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.ANDROID_NDK_VERSION }}
        run: |
          set -euo pipefail
          p4a aab \
            --private . \
            --package=org.example.smartlift \
            --name="SmartLift" \
            --version=1.0 \
            --bootstrap=sdl2 \
            --requirements=python3,kivy==2.2.1,pillow,sdl2 \
            --arch=arm64-v8a,armeabi-v7a,x86_64 \
            --copy-libs \
            --dist-name="${DIST_NAME}" \
            --android-api="${ANDROID_API}" \
            --ndk-api="${NDK_API}" \
            --sdk-dir="${ANDROID_SDK_ROOT}" \
            --ndk-dir="${ANDROID_SDK_ROOT}/ndk/${ANDROID_NDK_VERSION}" \
            --whitelist=whitelist.txt \
            --presplash=Preplash.png \
            --icon=Icon.png \
            --orientation=portrait \
            --permission=INTERNET \
            --wakelock \
            --release \
            --color=always

      - name: Generate CI signing key (throwaway)
        run: |
          set -euo pipefail
          keytool -genkeypair -v \
            -keystore "${KEYSTORE_PATH}" \
            -storepass "${KEYSTORE_PASS}" \
            -keypass "${KEY_PASS}" \
            -alias "${KEY_ALIAS}" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=CI, OU=CI, O=CI, L=CI, S=CI, C=US"

      - name: Download bundletool
        run: |
          set -euo pipefail
          wget -O "${BUNDLETOOL_JAR}" "${BUNDLETOOL_URL}"

      - name: Create universal APK from AAB
        run: |
          set -euo pipefail
          AAB_PATH=$(ls -1 dist/${DIST_NAME}/*.aab | head -n 1)
          echo "Using AAB: ${AAB_PATH}"

          # Build .apks archive with universal mode (single APK inside)
          java -jar "${BUNDLETOOL_JAR}" build-apks \
            --bundle="${AAB_PATH}" \
            --output="dist/${DIST_NAME}/universal.apks" \
            --mode=universal \
            --ks="${KEYSTORE_PATH}" \
            --ks-pass="pass:${KEYSTORE_PASS}" \
            --ks-key-alias="${KEY_ALIAS}" \
            --key-pass="pass:${KEY_PASS}"

          # Extract the single universal APK
          cd dist/${DIST_NAME}
          unzip -o universal.apks universal.apk
          mv universal.apk SmartLift-universal.apk
          ls -la

      - name: Upload universal APK
        uses: actions/upload-artifact@v4
        with:
          name: SmartLift-Universal-APK
          path: dist/${{ env.DIST_NAME }}/SmartLift-universal.apk
          if-no-files-found: error
