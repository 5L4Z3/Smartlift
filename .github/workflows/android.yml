name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: kivy/buildozer:latest
      options: --user root

    env:
      ANDROID_SDK_ROOT: /home/buildozer/.buildozer/android/platform/android-sdk
      ANDROID_NDK_ROOT: /home/buildozer/.buildozer/android/platform/android-ndk
      ANDROID_API: 33
      NDK_API: 21

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Copy project into container
        run: |
          mkdir -p /home/buildozer/project
          cp -r ./* /home/buildozer/project/
          chown -R buildozer:buildozer /home/buildozer/project
          cd /home/buildozer/project

      - name: Switch to buildozer user
        run: |
          sudo -u buildozer mkdir -p /home/buildozer/project/.buildozer

      - name: Build APK with p4a
        run: |
          cd /home/buildozer/project
          sudo -u buildozer python -m pythonforandroid.toolchain apk \
            --private . \
            --package=org.example.smartlift \
            --name="SmartLift" \
            --version=1.0 \
            --bootstrap=sdl2 \
            --requirements=python3,kivy==2.2.1,pillow,sdl2 \
            --arch=arm64-v8a \
            --copy-libs \
            --dist-name=smartlift \
            --android-api=$ANDROID_API \
            --ndk-api=$NDK_API \
            --whitelist=whitelist.txt \
            --presplash=Preplash.png \
            --icon=Icon.png \
            --orientation=portrait \
            --permission=INTERNET \
            --wakelock \
            --release \
            --color=always

      - name: Upload APK
        run: |
          cp /home/buildozer/project/dist/smartlift/*.apk /github/workspace/ || true
        continue-on-error: true

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SmartLift-APK
          path: |
            *.apk
            !venv/
          if-no-files-found: error
